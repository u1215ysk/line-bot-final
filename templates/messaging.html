{% extends "layout.html" %}
{% block title %}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡{% endblock %}
{% block header %}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡{% endblock %}

{% block content %}
<style>
    .message-creator { display: flex; flex-direction: column; gap: 1.5em; }
    .message-block { background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5em; }
    .message-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
    .message-block-header h3, .message-block-header h4, .message-block-header h5 { margin: 0; }
    .message-block select, .message-block input, .message-block textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; margin-top: 0.5em; }
    .message-block textarea { height: 100px; resize: vertical; }
    .add-message-btn { width: 100%; padding: 15px; background-color: #e9ecef; border: 2px dashed #ced4da; cursor: pointer; text-align: center; color: #495057; font-weight: bold; margin-top: 1.5em; }
    .add-message-btn:hover { background-color: #dde2e6; }
    .targeting-section, .broadcast-list-section { margin-bottom: 1.5em; }
    .tag-selection-group { display: flex; flex-wrap: wrap; gap: 10px; background-color: #fff; border: 1px solid var(--border-color); padding: 1em; border-radius: 4px; }
    .radio-group label { margin-right: 20px; }
    .action-group, .column-group { border-top: 1px dashed #ccc; margin-top: 1em; padding-top: 1em; }
    .action-item, .column-item { padding: 1em; border: 1px solid #eee; border-radius: 4px; margin-bottom: 1em; background: #fdfdfd; }
    .action-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
    .image-preview { max-width: 300px; max-height: 300px; margin-top: 10px; border-radius: 4px; border: 1px solid #ccc; object-fit: contain; }
</style>

<form id="delivery-form" action="{{ url_for('send_message_from_admin') }}" method="post" enctype="multipart/form-data">
    <div class="content-panel">
        <h2><span style="font-size: 1.2em;">ğŸ¯</span> é…ä¿¡å…ˆè¨­å®š</h2>
        <div class="radio-group">
            <label><input type="radio" name="targeting_type" value="all" checked onchange="toggleTargeting(this.value)"> å…¨å“¡ã«é…ä¿¡</label>
            <label><input type="radio" name="targeting_type" value="segmented" onchange="toggleTargeting(this.value)"> ã‚¿ã‚°ã§çµã‚Šè¾¼ã‚“ã§é…ä¿¡</label>
        </div>
        <div id="segment-options" style="display:none; margin-top: 1em;">
            <div class="targeting-section">
                <label><strong>å«ã‚ã‚‹ã‚¿ã‚°ï¼ˆANDæ¡ä»¶ï¼‰</strong></label>
                <div class="tag-selection-group">
                    {% for tag in tags %}<label><input type="checkbox" name="include_tags" value="{{ tag.name }}"> {{ tag.name }}</label>{% endfor %}
                </div>
            </div>
            <div class="targeting-section">
                <label><strong>é™¤å¤–ã™ã‚‹ã‚¿ã‚°</strong></label>
                <div class="tag-selection-group">
                    {% for tag in tags %}<label><input type="checkbox" name="exclude_tags" value="{{ tag.name }}"> {{ tag.name }}</label>{% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div id="message-container" class="message-creator"></div>
    <button type="button" class="add-message-btn" onclick="addMessageBlock()">+ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ </button>
    
    <div class="content-panel" style="margin-top: 2em;">
        <h2><span style="font-size: 1.2em;">ğŸš€</span> é…ä¿¡è¨­å®š</h2>
        <input type="text" name="broadcast_name" placeholder="ç®¡ç†ç”¨ã®é…ä¿¡åï¼ˆä»»æ„ï¼‰">
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 15px; flex-wrap: wrap; margin-top: 1em;">
            <input type="text" id="schedule-time-picker" name="send_at" placeholder="æ—¥æ™‚ã‚’æŒ‡å®šã—ã¦äºˆç´„..." style="width: auto; min-width: 180px;">
            <button type="button" onclick="submitForm(true)" class="button" style="background-color:#17a2b8;">äºˆç´„ã™ã‚‹</button>
            <button type="button" onclick="submitForm(false)" style="padding: 12px 30px; font-size: 1.2em;">ã™ãã«é€ä¿¡</button>
        </div>
    </div>
</form>

<div class="content-panel broadcast-list-section">
    <h2><span style="font-size: 1.2em;">ğŸ“«</span> äºˆç´„ä¸­ã®é…ä¿¡ä¸€è¦§</h2>
    <table>
        <thead>
            <tr>
                <th>é…ä¿¡å</th>
                <th>äºˆç´„æ—¥æ™‚</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for broadcast in broadcasts %}
            <tr>
                <td>{{ broadcast.name }}</td>
                <td>{{ broadcast.send_at_jst.strftime('%Y-%m-%d %H:%M') }}</td>
                <td>
                    <button onclick="openModal('{{ url_for('edit_broadcast_page', broadcast_id=broadcast.id) }}')" class="button" style="background-color:#6c757d;">ç·¨é›†</button>
                    <form action="{{ url_for('delete_broadcast', broadcast_id=broadcast.id) }}" method="post" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" style="display: inline;">
                        <button type="submit" class="button-delete">å‰Šé™¤</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="3" style="text-align: center;">äºˆç´„ä¸­ã®é…ä¿¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- â–¼â–¼â–¼ JavaScriptã§ä½¿ã†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç¾¤ â–¼â–¼â–¼ -->
<template id="message-block-template">
    <div class="message-block">
        <div class="message-block-header"><h3>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3><button type="button" class="button-delete" onclick="this.closest('.message-block').remove()">å‰Šé™¤</button></div>
        <select name="message_type" onchange="toggleMessageType(this)">
            <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
            <option value="image">ç”»åƒ</option>
            <option value="imagemap">ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒãƒƒãƒ—</option>
            <option value="button">ãƒœã‚¿ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</option>
            <option value="carousel">ã‚«ãƒ«ãƒ¼ã‚»ãƒ«</option>
        </select>
        <div class="message-content" style="margin-top: 1em;">
            <div class="input-group text-input"><textarea name="text_content" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹"></textarea></div>
            <div class="input-group image-input" style="display:none;">
                <label>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                <input type="file" name="image_file" accept="image/png, image/jpeg" onchange="previewImage(this)">
                <div class="preview-container"></div>
            </div>
            <div class="input-group imagemap-input" style="display:none;">
                <label>ãƒ™ãƒ¼ã‚¹ç”»åƒï¼ˆæ­£æ–¹å½¢ã‚’æ¨å¥¨ï¼‰</label>
                <input type="file" name="image_file" accept="image/png, image/jpeg" onchange="previewImage(this)">
                <div class="preview-container"></div>
                <input type="text" name="imagemap_alt_text" placeholder="é€šçŸ¥ç”¨ã®èª¬æ˜æ–‡" required>
                <div class="action-group">
                    <h5>ç”»åƒå…¨ä½“ã‚’ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h5>
                    <select name="imagemap_action_type"><option value="message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡</option><option value="uri">URLã‚’é–‹ã</option></select>
                    <input type="text" name="imagemap_action_data" placeholder="é€ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ or URL" required>
                </div>
            </div>
            <div class="input-group button-input" style="display:none;">
                <input type="text" name="button_title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰" maxlength="40">
                <textarea name="button_text" placeholder="æœ¬æ–‡" maxlength="160" rows="3"></textarea>
                <div class="action-container"></div>
                <button type="button" onclick="addAction(this, 'button')">+ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </button>
            </div>
            <div class="input-group carousel-input" style="display:none;">
                <input type="text" name="carousel_alt_text" placeholder="ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã®èª¬æ˜æ–‡" required>
                <div class="column-container"></div>
                <button type="button" onclick="addColumn(this)">+ ã‚«ãƒ©ãƒ ã‚’è¿½åŠ </button>
            </div>
        </div>
    </div>
</template>

<template id="carousel-column-template">
    <div class="column-item">
        <div class="message-block-header"><h4>ã‚«ãƒ©ãƒ </h4><button type="button" class="button-delete" onclick="this.closest('.column-item').remove()">Ã—</button></div>
        <input type="hidden" name="column_message_index" value="">
        <input type="text" name="column_title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" maxlength="40">
        <textarea name="column_text" placeholder="æœ¬æ–‡" maxlength="60" rows="3"></textarea>
        <input type="text" name="column_image_url" placeholder="ç”»åƒURLï¼ˆä»»æ„, HTTPSï¼‰">
        <div class="action-container"></div>
        <button type="button" onclick="addAction(this, 'carousel')">+ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </button>
    </div>
</template>

<template id="action-item-template">
    <div class="action-item">
        <div class="message-block-header"><h5>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h5><button type="button" class="button-delete" onclick="this.closest('.action-item').remove()">Ã—</button></div>
        <input type="hidden" name="action_message_index" value="">
        <input type="hidden" name="action_column_index" value="">
        <input type="text" name="action_label" placeholder="ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«" required>
        <select name="action_type"><option value="message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</option><option value="uri">URL</option></select>
        <input type="text" name="action_data" placeholder="é€ä¿¡ãƒ†ã‚­ã‚¹ãƒˆ or URL" required>
    </div>
</template>
<!-- â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² -->
{% endblock %}

{% block page_scripts %}
<script>
    function toggleTargeting(type) { document.getElementById('segment-options').style.display = (type === 'segmented') ? 'block' : 'none'; }
    const messageContainer = document.getElementById('message-container');
    const templates = {
        message: document.getElementById('message-block-template'),
        column: document.getElementById('carousel-column-template'),
        action: document.getElementById('action-item-template'),
    };
    let messageCounter = 0;
    let columnCounter = 0;

    function addMessageBlock() {
        if (messageContainer.children.length >= 5) { alert('ä¸€åº¦ã«é€ä¿¡ã§ãã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯5ã¤ã¾ã§ã§ã™ã€‚'); return; }
        const clone = templates.message.content.cloneNode(true);
        clone.querySelector('.button-input').dataset.messageIndex = messageCounter;
        clone.querySelector('.carousel-input').dataset.messageIndex = messageCounter;
        clone.querySelector('.imagemap-input').dataset.messageIndex = messageCounter;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®nameå±æ€§ãŒä¸€æ„ã«ãªã‚‹ã‚ˆã†ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’è¿½åŠ 
        clone.querySelectorAll('input[type="file"]').forEach(input => {
            input.name = `image_file_${messageCounter}`;
        });

        messageContainer.appendChild(clone);
        messageCounter++;
    }

    function toggleMessageType(selectElement) {
        const block = selectElement.closest('.message-block');
        block.querySelectorAll('.input-group').forEach(el => el.style.display = 'none');
        block.querySelector(`.${selectElement.value}-input`).style.display = 'block';
    }

    function addColumn(button) {
        const columnContainer = button.previousElementSibling;
        const messageIndex = button.closest('.carousel-input').dataset.messageIndex;
        if (columnContainer.children.length >= 10) { alert('ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã®ã‚«ãƒ©ãƒ ã¯10å€‹ã¾ã§ã§ã™ã€‚'); return; }
        const clone = templates.column.content.cloneNode(true);
        clone.querySelector('input[name="column_message_index"]').value = messageIndex;
        clone.querySelector('.action-container').dataset.columnIndex = columnCounter;
        columnContainer.appendChild(clone);
        columnCounter++;
    }

    function addAction(button, type) {
        const actionContainer = button.previousElementSibling;
        const messageBlock = button.closest('.message-block');
        const columnItem = button.closest('.column-item');
        const messageIndex = messageBlock.querySelector('.button-input, .carousel-input').dataset.messageIndex;
        const columnIndex = columnItem ? actionContainer.dataset.columnIndex : '-1';
        const maxActions = (type === 'carousel') ? 3 : 4;
        if (actionContainer.children.length >= maxActions) { alert(`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯${maxActions}ã¤ã¾ã§ã§ã™ã€‚`); return; }
        const clone = templates.action.content.cloneNode(true);
        clone.querySelector('input[name="action_message_index"]').value = messageIndex;
        clone.querySelector('input[name="action_column_index"]').value = columnIndex;
        actionContainer.appendChild(clone);
    }
    
    function previewImage(input) {
        const previewContainer = input.nextElementSibling;
        previewContainer.innerHTML = '';
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.classList.add('image-preview');
                previewContainer.appendChild(img);
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function submitForm(isScheduled) {
        const form = document.getElementById('delivery-form');
        const scheduleInput = document.getElementById('schedule-time-picker');
        if (isScheduled) {
            if (!scheduleInput.value) {
                alert('äºˆç´„æ—¥æ™‚ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            form.action = "{{ url_for('schedule_broadcast_from_admin') }}";
        } else {
            scheduleInput.value = '';
            form.action = "{{ url_for('send_message_from_admin') }}";
        }
        form.submit();
    }

    flatpickr("#schedule-time-picker", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        locale: "ja",
        minuteIncrement: 1
    });

    document.addEventListener('DOMContentLoaded', addMessageBlock);
</script>
{% endblock %}

