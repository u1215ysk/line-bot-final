{% extends "layout.html" %}
{% block title %}ãƒˆãƒ¼ã‚¯å±¥æ­´{% endblock %}
{% block header %}ãƒˆãƒ¼ã‚¯å±¥æ­´: {{ user.nickname or user.display_name or user.id }}{% endblock %}

{% block content %}
<style>
    .chat-header { 
        padding: 1em; 
        background-color: #f8f9fa; 
        border: 1px solid var(--border-color); 
        border-bottom: none; 
        border-radius: 8px 8px 0 0; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        flex-wrap: wrap;
        gap: 1em;
    }
    .status-form select { 
        padding: 5px; 
        border-radius: 4px; 
        border: 1px solid #ccc;
    }
    .chat-container { 
        display: flex; 
        flex-direction: column; 
        height: 70vh;
    }
    .message-history { 
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 1em; 
        background-color: #f5f5f5; 
        border: 1px solid var(--border-color); 
        border-bottom: none;
    }
    .message { 
        max-width: 70%; 
        padding: 10px 15px; 
        border-radius: 18px; 
        margin-bottom: 10px; 
        line-height: 1.4;
        white-space: pre-wrap;
    }
    .message.user { 
        background-color: #ffffff; 
        align-self: flex-start; 
        border: 1px solid var(--border-color);
    }
    .message.admin { 
        background-color: #dcf8c6; 
        align-self: flex-end; 
    }
    .message-row { 
        display: flex; 
        flex-direction: column; 
    }
    .message-row.user { 
        align-items: flex-start; 
    }
    .message-row.admin { 
        align-items: flex-end; 
    }
    .reply-form {
        padding: 1em; 
        background-color: #f0f0f0; 
        border: 1px solid var(--border-color); 
        border-top: none; 
        border-radius: 0 0 8px 8px;
    }
    .reply-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        align-items: center;
    }
    .reply-actions button, .reply-actions span {
        flex-shrink: 0;
    }
    #schedule-time-picker {
        width: auto;
        min-width: 160px;
    }
    .scheduled-panel { border: 1px solid #ffc107; background-color: #fff3cd; border-radius: 8px; padding: 1em; margin-bottom: 2em; }
    .scheduled-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5em 0; border-bottom: 1px solid #ffeeba; }
    .scheduled-item:last-child { border-bottom: none; }
    .scheduled-text { flex-grow: 1; }
</style>

<div class="content-panel">
    <div class="scheduled-panel">
        <h4>ğŸ“« äºˆç´„ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h4>
        {% if scheduled_messages %}
            {% for msg in scheduled_messages %}
            <div class="scheduled-item">
                <div class="scheduled-text">
                    <strong>{{ msg.send_at.strftime('%Y-%m-%d %H:%M') }}</strong>: {{ msg.message_text|truncate(40) }}
                </div>
                <div>
                    <button onclick="openModal('{{ url_for('edit_scheduled_page', msg_id=msg.id) }}')" class="button" style="background-color:#6c757d; padding: 5px 10px;">ç·¨é›†</button>
                    <form action="{{ url_for('delete_scheduled', msg_id=msg.id) }}" method="post" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');" style="display: inline;">
                        <button type="submit" class="button-delete" style="padding: 5px 10px;">å‰Šé™¤</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®äºˆç´„æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>

    <div class="chat-header">
        <div>
            <strong>ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> {{ user.status }}
            <button onclick="openModal('{{ url_for('edit_user_page', user_id=user.id) }}')" style="margin-left: 15px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç·¨é›†</button>
        </div>
        <form class="status-form" action="{{ url_for('update_status', user_id=user.id) }}" method="post" style="display: flex; align-items: center; gap: 10px;">
            <select name="status">
                <option value="æœªå¯¾å¿œ" {% if user.status == 'æœªå¯¾å¿œ' %}selected{% endif %}>æœªå¯¾å¿œ</option>
                <option value="å¯¾å¿œä¸­" {% if user.status == 'å¯¾å¿œä¸­' %}selected{% endif %}>å¯¾å¿œä¸­</option>
                <option value="å¯¾å¿œæ¸ˆã¿" {% if user.status == 'å¯¾å¿œæ¸ˆã¿' %}selected{% endif %}>å¯¾å¿œæ¸ˆã¿</option>
                <option value="è¦å¯¾å¿œ" {% if user.status == 'è¦å¯¾å¿œ' %}selected{% endif %}>è¦å¯¾å¿œ</option>
            </select>
            <button type="submit">å¤‰æ›´</button>
        </form>
    </div>

    <div class="chat-container">
        <div class="message-history">
            {% for msg in messages %}
            <div class="message-row {{ msg.sender_type }}">
                <div class="message {{ msg.sender_type }}">
                    {{ msg.content }}
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="reply-form">
            <form id="reply-form" action="{{ url_for('send_reply', user_id=user.id) }}" method="post">
                <textarea name="message_text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="3" style="width: 100%; box-sizing: border-box;"></textarea>
                <div class="reply-actions">
                    <button type="submit">ã™ãã«é€ä¿¡</button>
                    <span style="color: #666;">ã¾ãŸã¯</span>
                    <input type="text" id="schedule-time-picker" name="send_at" placeholder="æ—¥æ™‚ã‚’é¸æŠ...">
                    <button type="button" onclick="scheduleMessage()">äºˆç´„ã—ã¦é€ä¿¡</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    function scheduleMessage() {
        const form = document.getElementById('reply-form');
        form.action = "{{ url_for('schedule_reply', user_id=user.id) }}";
        form.submit();
    }

    flatpickr("#schedule-time-picker", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        locale: "ja",
        defaultDate: new Date(),
        minuteIncrement: 1
    });
</script>
{% endblock %}