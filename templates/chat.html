{% extends "layout.html" %}
{% block title %}個別トーク{% endblock %}
{% block header %}個別トーク{% endblock %}

{% block content %}
<style>
    .filter-nav { margin-bottom: 1em; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .filter-nav a { padding: 8px 12px; border-radius: 4px; text-decoration: none; background-color: #e9ecef; color: #495057; }
    .filter-nav a.active { background-color: var(--primary-color); color: white; font-weight: bold; }
    tr[data-href] { cursor: pointer; }
    tr[data-href]:hover { background-color: #f8f9fa; }
    .message-preview { color: #6c757d; font-size: 0.9em; }
    .search-form { display: flex; gap: 10px; }
    .search-form input { flex-grow: 1; }
</style>

<div class="content-panel">
    <h2><span style="font-size: 1.2em;">💬</span> 会話一覧</h2>
    
    <div class="filter-nav">
        <a href="{{ url_for('admin_chat_page', q=search_query) }}" class="{{ 'active' if not current_filter }}">全て</a>
        <a href="{{ url_for('admin_chat_page', status='未対応', q=search_query) }}" class="{{ 'active' if current_filter == '未対応' }}">未対応</a>
        <a href="{{ url_for('admin_chat_page', status='対応中', q=search_query) }}" class="{{ 'active' if current_filter == '対応中' }}">対応中</a>
        <a href="{{ url_for('admin_chat_page', status='要対応', q=search_query) }}" class="{{ 'active' if current_filter == '要対応' }}">要対応</a>
        <a href="{{ url_for('admin_chat_page', status='対応済み', q=search_query) }}" class="{{ 'active' if current_filter == '対応済み' }}">対応済み</a>
    </div>

    <form method="get" action="{{ url_for('admin_chat_page') }}" class="search-form" style="margin-bottom: 1em;">
        <input type="text" name="q" placeholder="表示名、ニックネーム、トーク内容で検索..." value="{{ search_query or '' }}">
        <input type="hidden" name="status" value="{{ current_filter or '' }}">
        <button type="submit">検索</button>
    </form>

    <table>
        <thead>
            <tr>
                <th>ステータス</th>
                <th>LINE表示名</th>
                <th>最終メッセージ</th>
                <th>日時</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr data-href="{{ url_for('admin_chat_detail_page', user_id=user.id) }}">
                <td>{{ user.status }}</td>
                <td>{{ user.nickname or user.display_name }}</td>
                <td>
                    {% set last_msg = latest_messages.get(user.id) %}
                    {% if last_msg %}
                        <span class="message-preview">
                            {% if last_msg.sender_type == 'admin' %}<strong>あなた:</strong> {% endif %}
                            {{ last_msg.content | truncate(30) }}
                        </span>
                    {% else %}
                        <span class="message-preview">まだメッセージはありません</span>
                    {% endif %}
                </td>
                <td>
                    {% if last_msg %}
                        {{ last_msg.created_at.strftime('%m-%d %H:%M') }}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const rows = document.querySelectorAll('tr[data-href]');
        rows.forEach(row => {
            row.addEventListener('click', () => {
                window.location.href = row.dataset.href;
            });
        });
    });
</script>
{% endblock %}