{% extends "layout.html" %}
{% block title %}å€‹åˆ¥ãƒˆãƒ¼ã‚¯{% endblock %}
{% block header %}å€‹åˆ¥ãƒˆãƒ¼ã‚¯{% endblock %}

{% block content %}
<style>
    .filter-nav { margin-bottom: 1em; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .filter-nav a { padding: 8px 12px; border-radius: 4px; text-decoration: none; background-color: #e9ecef; color: #495057; }
    .filter-nav a.active { background-color: var(--primary-color); color: white; font-weight: bold; }
    tr[data-href] { cursor: pointer; }
    tr[data-href]:hover { background-color: #f8f9fa; }
    .message-preview { color: #6c757d; font-size: 0.9em; }
    .search-form { display: flex; gap: 10px; }
    .search-form input { flex-grow: 1; }
</style>

<div class="content-panel">
    <h2><span style="font-size: 1.2em;">ğŸ’¬</span> ä¼šè©±ä¸€è¦§</h2>
    
    <div class="filter-nav">
        <a href="{{ url_for('admin_chat_page', q=search_query) }}" class="{{ 'active' if not current_filter }}">å…¨ã¦</a>
        <a href="{{ url_for('admin_chat_page', status='æœªå¯¾å¿œ', q=search_query) }}" class="{{ 'active' if current_filter == 'æœªå¯¾å¿œ' }}">æœªå¯¾å¿œ</a>
        <a href="{{ url_for('admin_chat_page', status='å¯¾å¿œä¸­', q=search_query) }}" class="{{ 'active' if current_filter == 'å¯¾å¿œä¸­' }}">å¯¾å¿œä¸­</a>
        <a href="{{ url_for('admin_chat_page', status='è¦å¯¾å¿œ', q=search_query) }}" class="{{ 'active' if current_filter == 'è¦å¯¾å¿œ' }}">è¦å¯¾å¿œ</a>
        <a href="{{ url_for('admin_chat_page', status='å¯¾å¿œæ¸ˆã¿', q=search_query) }}" class="{{ 'active' if current_filter == 'å¯¾å¿œæ¸ˆã¿' }}">å¯¾å¿œæ¸ˆã¿</a>
    </div>

    <form method="get" action="{{ url_for('admin_chat_page') }}" class="search-form" style="margin-bottom: 1em;">
        <input type="text" name="q" placeholder="è¡¨ç¤ºåã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€ãƒˆãƒ¼ã‚¯å†…å®¹ã§æ¤œç´¢..." value="{{ search_query or '' }}">
        <input type="hidden" name="status" value="{{ current_filter or '' }}">
        <button type="submit">æ¤œç´¢</button>
    </form>

    <table>
        <thead>
            <tr>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>LINEè¡¨ç¤ºå</th>
                <th>æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                <th>æ—¥æ™‚</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr data-href="{{ url_for('admin_chat_detail_page', user_id=user.id) }}">
                <td>{{ user.status }}</td>
                <td>{{ user.nickname or user.display_name }}</td>
                <td>
                    {% set last_msg = latest_messages.get(user.id) %}
                    {% if last_msg %}
                        <span class="message-preview">
                            {% if last_msg.sender_type == 'admin' %}<strong>ã‚ãªãŸ:</strong> {% endif %}
                            {{ last_msg.content | truncate(30) }}
                        </span>
                    {% else %}
                        <span class="message-preview">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</span>
                    {% endif %}
                </td>
                <td>
                    {% if last_msg %}
                        {{ last_msg.created_at.strftime('%m-%d %H:%M') }}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const rows = document.querySelectorAll('tr[data-href]');
        rows.forEach(row => {
            row.addEventListener('click', () => {
                window.location.href = row.dataset.href;
            });
        });
    });
</script>
{% endblock %}